{% comment %}
  WhatsApp Button Block
  Adds a floating WhatsApp button to the store
{% endcomment %}

{% if block.settings.enabled %}
  <div class="whatsapp-button-wrapper" id="whatsapp-button-wrapper" style="display: none;">
    <!-- WhatsApp Icon and Text -->
    <div class="whatsapp-toggle-container" id="whatsapp-container">
      <a id="whatsapp-main-link" href="#" target="_blank" rel="noopener noreferrer" class="whatsapp-toggle-icon" title="Chat with us on WhatsApp">
        {% case block.settings.custom_icon %}
          {% when 'chat1' %}
            <img id="whatsapp-icon-img-main" src="{{ 'chat-icon-1.svg' | asset_url }}" alt="Chat" height="60px" width="60px">
          {% when 'chat2' %}
            <img id="whatsapp-icon-img-main" src="{{ 'chat-icon-2.svg' | asset_url }}" alt="Chat" height="60px" width="60px">
          {% when 'chat3' %}
            <img id="whatsapp-icon-img-main" src="{{ 'chat-icon-3.svg' | asset_url }}" alt="Chat" height="60px" width="60px">
          {% else %}
            <img id="whatsapp-icon-img-main" src="{{ 'whatsapp.png' | asset_url }}" alt="WhatsApp" height="60px" width="60px">
        {% endcase %}
      </a>
        <a id="whatsapp-text-link"
        href="#"
        target="_blank"
        rel="noopener noreferrer">
      <span class="whatsapp-toggle-text" id="whatsapp-text" style="display: none;">WhatsApp us</span>
      </a>
    </div>
    
    <!-- WhatsApp Widget (hidden by default) -->
    <div id="whatsapp-widget" class="whatsapp-widget" style="display: none;">
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" id="show-text-toggle"> Show icon with text</label>
      </div>
      <div style="margin-bottom:10px;">
        <label style="margin-right:10px;"><input type="radio" name="whatsapp-position" value="left"> Left</label>
        <label><input type="radio" name="whatsapp-position" value="right" checked> Right</label>
      </div>
      <a id="whatsapp-link-widget"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
        class="whatsapp-embed-logo"
        title="Chat with us on WhatsApp">
        {% case block.settings.custom_icon %}
          {% when 'chat1' %}
            <img id="whatsapp-icon-img-widget" src="{{ 'chat-icon-1.svg' | asset_url }}" alt="Chat" height="60px" width="60px" loading="lazy">
          {% when 'chat2' %}
            <img id="whatsapp-icon-img-widget" src="{{ 'chat-icon-2.svg' | asset_url }}" alt="Chat" height="60px" width="60px" loading="lazy">
          {% when 'chat3' %}
            <img id="whatsapp-icon-img-widget" src="{{ 'chat-icon-3.svg' | asset_url }}" alt="Chat" height="60px" width="60px" loading="lazy">
          {% else %}
            <img id="whatsapp-icon-img-widget" src="{{ 'whatsapp.png' | asset_url }}" alt="WhatsApp" height="60px" width="60px" loading="lazy">
        {% endcase %}
      </a>
      <div style="margin-top:10px;">
        <label for="whatsapp-message">Message</label>
        <textarea id="whatsapp-message" maxLength=50 rows="2" style="width:100%;resize:none;"></textarea>
      </div>
    </div>
  </div>

  {{ 'whatsapp-logo.css' | asset_url | stylesheet_tag }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Asset URLs for dynamic icon switching
      const assets = {
        'whatsapp': "{{ 'whatsapp.png' | asset_url }}",
        'chat1': "{{ 'chat-icon-1.svg' | asset_url }}",
        'chat2': "{{ 'chat-icon-2.svg' | asset_url }}",
        'chat3': "{{ 'chat-icon-3.svg' | asset_url }}"
      };

      // Get shop domain from URL
      function getShopDomain() {
        if(typeof window !== 'undefined') {
          return window.location.host;
        }
        return null;
      }
      
      // REAL API CALL: Fetch phone number with dynamic shop domain header and update WhatsApp link
      async function fetchPhoneNumberAndUpdateLink() {
        const shopDomain = getShopDomain();
        if (!shopDomain) {
          console.error('Shop domain not found in URL');
          return;
        }
        try {
          const response = await fetch('https://whatsapp-mern-backend-sidn.onrender.com/api/phone', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-shopify-shop-domain': shopDomain
            },
            credentials: 'include'
          });
          const result = await response.json();
          const wrapper = document.getElementById('whatsapp-button-wrapper');
          
          if (result && Array.isArray(result.data) && result.data.length > 0) {
            const phoneData = result.data[0];
            const whatsappLinkWidget = document.getElementById('whatsapp-link-widget');
            const whatsappMainLink = document.getElementById('whatsapp-main-link');
            const whatsappTextLink = document.getElementById('whatsapp-text-link');
            const messageInput = document.getElementById('whatsapp-message');
            const textElement = document.getElementById('whatsapp-text');
            const iconMain = document.getElementById('whatsapp-icon-img-main');
            const iconWidget = document.getElementById('whatsapp-icon-img-widget');
            
            // Show wrapper as we have data
            if (wrapper) wrapper.style.display = 'block';

            const apiMessage = phoneData.message || "";
            const apiPosition = phoneData.position || "right";
            const apiButtonStyle = phoneData.button_style || "icon_only";
            const apiCustomIcon = phoneData.custom_icon || "whatsapp";
            
            if (messageInput) {
              messageInput.value = apiMessage;
            }
            
            if (textElement) {
              textElement.style.display = apiButtonStyle === 'icon_with_text' ? 'inline-block' : 'none';
            }

            // Update Icons
            const iconSrc = assets[apiCustomIcon] || assets['whatsapp'];
            if (iconMain && iconSrc) iconMain.src = iconSrc;
            if (iconWidget && iconSrc) iconWidget.src = iconSrc;

            function updateWhatsAppLinks() {
              const fullNumber = (phoneData.country_code + phoneData.phone_number).replace(/(\+)(?=\d)/g, "").replace(/\D/g, "");
              let baseLink = `https://wa.me/${fullNumber}`;
              let msg = messageInput ? messageInput.value.trim() : apiMessage;
              const finalLink = msg ? `${baseLink}?text=${encodeURIComponent(msg)}` : baseLink;
              
              if (whatsappLinkWidget) whatsappLinkWidget.href = finalLink;
              if (whatsappMainLink) whatsappMainLink.href = finalLink;
              if (whatsappTextLink) whatsappTextLink.href = finalLink;
            }

            updateWhatsAppLinks();
            
            // Update Position
            const container = document.getElementById('whatsapp-container');
            if (container) {
              container.style.right = '';
              container.style.left = '';
              container.style[apiPosition] = '30px';
            }

            if (messageInput) {
              messageInput.addEventListener('input', updateWhatsAppLinks);
            }

            if (window.Shopify && window.Shopify.designMode) {
              [whatsappLinkWidget, whatsappMainLink, whatsappTextLink].forEach(link => {
                if (link) {
                  link.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('WhatsApp link preview is disabled in the theme editor. This will work on your live store.');
                  });
                }
              });
            }
          } else {
            // Hide wrapper if no data
            if (wrapper) wrapper.style.display = 'none';
          }
        } catch (error) {
          console.error('Error calling phone API:', error);
        }
      }

      function initToggle() {
        const container = document.getElementById('whatsapp-container');
        const widget = document.getElementById('whatsapp-widget');
        const textElement = document.getElementById('whatsapp-text');
        const showTextToggle = document.getElementById('show-text-toggle');
        let isWidgetVisible = false;
        
        if (container && widget) {
          container.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            isWidgetVisible = !isWidgetVisible;
            widget.style.display = isWidgetVisible ? 'block' : 'none';
          });
        }
        
        if (showTextToggle && textElement) {
          showTextToggle.addEventListener('change', function() {
            textElement.style.display = this.checked ? 'inline-block' : 'none';
          });
        }
      }
      
      function setIconPosition() {
        let container = document.getElementById('whatsapp-container');
        let radios = document.getElementsByName('whatsapp-position');
        if (!container || !radios) return;
        
        function updateIconPosition(position) {
          container.style.right = '';
          container.style.left = '';
          if (position === 'left') {
            container.style.left = '30px';
          } else {
            container.style.right = '30px';
          }
        }
        
        radios.forEach(function(radio) {
          radio.addEventListener('change', function() {
            if (this.checked) updateIconPosition(this.value);
          });
        });
      }
      
      fetchPhoneNumberAndUpdateLink();
      setIconPosition();
      initToggle();
      
      if (window.Shopify && window.Shopify.designMode) {
        const toggleInput = document.querySelector('input[name*="[enabled]"]');
        if (toggleInput) {
          toggleInput.addEventListener('change', function() {
            if (this.checked) {
              fetchPhoneNumberAndUpdateLink();
            }
          });
        }
      }
    });
  </script>
{% endif %}


{% schema %}
{
  "name": "TapTalk",
  "target": "body",
  
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable WhatsApp Button",
      "default": true,
      "info": "Toggle to show or hide the WhatsApp button"
    }
  ]
}
{% endschema %}