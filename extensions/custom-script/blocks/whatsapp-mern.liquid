{% comment %}
  WhatsApp Button Block
  Adds a floating WhatsApp button to the store
{% endcomment %}

{% if block.settings.enabled %}
  <div class="whatsapp-button-wrapper" id="whatsapp-button-wrapper">
    <!-- WhatsApp Icon and Text -->
    <div class="whatsapp-toggle-container" id="whatsapp-container">
      <a id="whatsapp-main-link" href="#" target="_blank" rel="noopener noreferrer" class="whatsapp-toggle-icon" title="Chat with us on WhatsApp">
        <img src="{{ 'whatsapp.png' | asset_img_url }}" alt="WhatsApp" height="60px" width="60px">
      </a>
      <span class="whatsapp-toggle-text" id="whatsapp-text" style="display: {% if block.settings.show_text %}inline-block{% else %}none{% endif %};">WhatsApp us</span>
    </div>
    
    <!-- WhatsApp Widget (hidden by default) -->
    <div id="whatsapp-widget" class="whatsapp-widget" style="display: none;">
      <div style="margin-bottom:10px;">
        <label><input type="checkbox" id="show-text-toggle"> Show icon with text</label>
      </div>
      <div style="margin-bottom:10px;">
        <label>Icon Position:</label>
        <label style="margin-right:10px;"><input type="radio" name="whatsapp-position" value="left"> Left</label>
        <label><input type="radio" name="whatsapp-position" value="right" checked> Right</label>
      </div>
      <a id="whatsapp-link"
        href="https://wa.me/{{ block.settings.phone_number | default: '' }}"
        target="_blank"
        rel="noopener noreferrer"
        class="whatsapp-embed-logo"
        title="Chat with us on WhatsApp">
        <img src="{{ 'whatsapp.png' | asset_img_url }}" 
          alt="WhatsApp" 
          height="60px"
          width="60px"
          loading="lazy">
      </a>
      <div style="margin-top:10px;">
        <label for="whatsapp-message">Message</label>
        <textarea id="whatsapp-message" maxLength=50 rows="2" style="width:100%;resize:none;"></textarea>
      </div>
    </div>
  </div>

  {{ 'whatsapp-logo.css' | asset_url | stylesheet_tag }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    

      // Get shop domain from URL
      function getShopDomain() {
        if(typeof window !== 'undefined') {
          const match = window.location.host
           return match 
            // Return null if no match is found
          }
          return null;
      }
      
      // REAL API CALL: Fetch phone number with dynamic shop domain header and update WhatsApp link
      async function fetchPhoneNumberAndUpdateLink() {
        const shopDomain = getShopDomain();
        if (!shopDomain) {
          console.error('Shop domain not found in URL');
          return;
        }
        try {
          const response = await fetch('https://whatsapp-mern-backend-sidn.onrender.com/api/phone', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-shopify-shop-domain': shopDomain
            },
            credentials: 'include'
          });
          const result = await response.json();
          const whatsappLink = document.getElementById('whatsapp-link');
          const whatsappMainLink = document.getElementById('whatsapp-main-link');
          const messageInput = document.getElementById('whatsapp-message');
          // Set default message from schema if available
          if (messageInput) {
            messageInput.value = "{{ block.settings.default_message | escape }}";
          }
          function updateWhatsAppLinkWithMessage(baseLink) {
            let msg = messageInput ? messageInput.value.trim() : '';
            if (msg.length > 0) {
              // Encode message for URL
              return `${baseLink}?text=${encodeURIComponent(msg)}`;
            }
            return baseLink;
          }
          if (result && Array.isArray(result.data) && result.data.length > 0) {
            const links = result.data.map((item, idx) => {
              if (item.country_code && item.phone_number) {
                const country = item.country_code.replace(/^\+/, '');
                const phone = item.phone_number;
                const waLink = `https://wa.me/${country}${phone}`;
                return waLink;
              }
              return null;
            }).filter(Boolean);
            if (links.length > 0) {
              // Update both links
              const finalLink = updateWhatsAppLinkWithMessage(links[0]);
              if (whatsappLink) whatsappLink.href = finalLink;
              if (whatsappMainLink) whatsappMainLink.href = finalLink;
              
              // Update links on message change
              if (messageInput) {
                messageInput.addEventListener('input', function() {
                  const updatedLink = updateWhatsAppLinkWithMessage(links[0]);
                  if (whatsappLink) whatsappLink.href = updatedLink;
                  if (whatsappMainLink) whatsappMainLink.href = updatedLink;
                });
              }
              // Prevent links from opening in theme editor
              if (window.Shopify && window.Shopify.designMode) {
                [whatsappLink, whatsappMainLink].forEach(link => {
                  if (link) {
                    link.addEventListener('click', function(e) {
                      e.preventDefault();
                      alert('WhatsApp link preview is disabled in the theme editor. This will work on your live store.');
                    });
                  }
                });
              }
            } else {
              console.error('No valid phone data found in API response.');
            }
          } else {
            console.error('API did not return valid phone data');
          }
        } catch (error) {
          console.error('Error calling phone API:', error);
        }
      }

      // Toggle functionality
      function initToggle() {
        const container = document.getElementById('whatsapp-container');
        const widget = document.getElementById('whatsapp-widget');
        const textElement = document.getElementById('whatsapp-text');
        const showTextToggle = document.getElementById('show-text-toggle');
        const mainLink = document.getElementById('whatsapp-main-link');
        let isWidgetVisible = false;
        
        // Right-click on container to show/hide widget
        if (container && widget) {
          container.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            isWidgetVisible = !isWidgetVisible;
            widget.style.display = isWidgetVisible ? 'block' : 'none';
          });
        }
        
        // Toggle text visibility
        if (showTextToggle && textElement) {
          showTextToggle.checked = {{ block.settings.show_text | json }};
          showTextToggle.addEventListener('change', function() {
            textElement.style.display = this.checked ? 'inline-block' : 'none';
          });
        }
      }
      
      // Set icon position based on radio selection
      function setIconPosition() {
        let container = document.getElementById('whatsapp-container');
        let radios = document.getElementsByName('whatsapp-position');
        if (!container || !radios) return;
        
        function updateIconPosition(position) {
          container.style.right = '';
          container.style.left = '';
          if (position === 'left') {
            container.style.left = '30px';
          } else {
            container.style.right = '30px';
          }
        }
        
        let initial = '{{ block.settings.icon_position | escape }}' || 'right';
        updateIconPosition(initial);
        
        radios.forEach(function(radio) {
          radio.checked = radio.value === initial;
          radio.addEventListener('change', function() {
            if (this.checked) updateIconPosition(this.value);
          });
        });
      }
      
      // Call real API only if block is enabled
      if ({{ block.settings.enabled | json }}) {
        fetchPhoneNumberAndUpdateLink();
        setIconPosition();
        initToggle();
      }
      
      // Listen for theme editor changes
      if (window.Shopify && window.Shopify.designMode) {
        // This will run in the theme editor
        const toggleInput = document.querySelector('input[name*="[enabled]"]');
        if (toggleInput) {
          toggleInput.addEventListener('change', function() {
            if (this.checked) {
              updateWhatsAppLink();
            }
          });
        }
      }
    });
  </script>
{% endif %}

{% schema %}
{
  "name": "TapTalk",
  "target": "body",
  
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable WhatsApp Button",
      "default": true,
      "info": "Toggle to show or hide the WhatsApp button"
    },
    {
      "type": "checkbox",
      "id": "show_text",
      "label": "Show icon with text",
      "default": false,
      "info": "Show 'WhatsApp us' text next to the icon"
    },
    {
      "type": "textarea",
      "id": "default_message",
      "label": "Default WhatsApp Message",
      "default": "Hey, ",
      "info": "Default message for WhatsApp chat"
    },
    {
      "type": "radio",
      "id": "icon_position",
      "label": "WhatsApp Icon Position",
      "default": "right",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "right", "label": "Right" }
      ],
      "info": "Set the position of the WhatsApp icon (left or right)"
    }
  ]
}
{% endschema %}